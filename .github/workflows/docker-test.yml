name: Docker Build & Test

# main ë¸Œëžœì¹˜ì— pushë˜ê±°ë‚˜ PRì´ mergeë  ë•Œ ì‹¤í–‰
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  docker-test:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. .env íŒŒì¼ ìƒì„± (í…ŒìŠ¤íŠ¸ìš©)
      - name: Create .env file for CI
        run: |
          cat > .env << EOF
          MONGODB_HOST=mongodb
          MONGODB_PORT=27017
          MONGODB_USERNAME=admin
          MONGODB_PASSWORD=test_password_123
          MONGODB_DATABASE=daily_diary
          ME_CONFIG_BASICAUTH_USERNAME=admin
          ME_CONFIG_BASICAUTH_PASSWORD=test_password_123
          TZ=Asia/Seoul
          EOF
          echo "âœ… .env file created"

      # 3. MongoDB ì„œë¹„ìŠ¤ ì‹œìž‘
      - name: Start MongoDB service
        run: |
          docker compose up -d mongodb
          echo "â³ Waiting for MongoDB to be ready..."
          sleep 10
          echo "âœ… MongoDB is ready"

      # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker image
        run: |
          docker compose build daily-cli
          echo "âœ… Docker image built successfully"

      # 5. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ (--help)
      - name: Test application startup
        run: |
          echo "ðŸ§ª Testing application with --help..."
          docker compose run --rm daily-cli python main.py --help
          echo "âœ… Application runs without errors"

      # 6. ì •ë¦¬ (Clean up)
      - name: Clean up
        if: always()
        run: |
          docker compose down -v
          echo "âœ… Cleanup completed"

      # 7. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
      - name: Test Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All tests passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ“ Docker image built successfully"
          echo "âœ“ MongoDB connection established"
          echo "âœ“ Application starts without errors"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
